version: '3'

vars:
  workspace: '{{.WORKSPACE | default "poc02"}}'

includes:
  ingress: ./task_modules/Ingress/Taskfile.yml
  logging: ./task_modules/Loki/Taskfile.yml
  cert-manager: ./task_modules/CertManager/Taskfile.yml
  demo-apps: ./task_modules/DemoApplications/Taskfile.yml

tasks:

  # Build Azure kluster infrastructure.
  infrastructure:build:
    cmds:
      - terraform apply

  # Tear down aks cluster
  infrastructure:destroy:
    cmds:
      - terraform destroy

  # Installs ingress and cert manager.
  ingress:setup:
    deps: [aks:mount]
    cmds:
      # Setup Ingress.
      - task: ingress:setup
      # Setup cert-manager.
      - task: cert-manager:setup
 
  # Installs demo applications.
  demo-apps:setup:
    deps: [aks:mount]
    cmds:
      - task: demo-apps:install
 
 # Adds Loki logging.
  logging:setup:
    deps: [aks:mount]
    cmds:
      - task: logging:setup
 
 # Authenticates to aks cluster.
  aks:mount:
    cmds:
      - az aks get-credentials --resource-group {{.workspace}}-rg --name {{.workspace}}-cluster
 
  # Main task for running the whole show.
  setup:
    deps:
      - infrastructure:build
    cmds:
      - task: aks:mount
      - task: ingress:setup
      - task: logging:setup
      - task: demo-apps:setup